<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Madrasah Diniyah Nurul Yusuf</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library JSZip untuk membuat file ZIP (digunakan untuk ekspor CSV ganda) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Library docx untuk membuat file Word -->
    <script src="https://unpkg.com/docx@8.2.2/build/index.js"></script>
    <!-- Library FileSaver.js untuk menyimpan file -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .message-modal {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .message-modal.show { opacity: 1; visibility: visible; }
        .message-modal-content {
            background: white; padding: 24px; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); max-width: 400px;
            width: 90%; text-align: center; transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .message-modal.show .message-modal-content { transform: translateY(0); }
        .message-modal-icon { margin-bottom: 16px; }
        .message-modal-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 8px; }
        .message-modal-body { font-size: 0.95rem; color: #4a5568; margin-bottom: 24px; white-space: pre-wrap; }
        .message-modal-button {
            padding: 10px 20px; border-radius: 6px; font-weight: 600;
            cursor: pointer; transition: background-color 0.2s ease; border: none;
        }
        .message-modal-button.success { background: #10b981; color: white; }
        .message-modal-button.success:hover { background: #059669; }
        .message-modal-button.error { background: #ef4444; color: white; }
        .message-modal-button.error:hover { background: #dc2626; }
        .message-modal-button.cancel { background: #6b7280; color: white; }
        .message-modal-button.cancel:hover { background: #4b5563; }

        .loading-overlay {
            position: fixed; inset: 0; background: rgba(255, 255, 255, 0.85);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 2001; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .loading-overlay.show { opacity: 1; visibility: visible; }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #10b981;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-size: 1.1rem; font-weight: 600; color: #374151; }
        .loading-details { margin-top: 8px; font-size: 0.9rem; color: #4a5568; }

        .custom-dropdown {
            position: absolute; top: 100%; right: 0; background-color: white;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 8px; z-index: 999; opacity: 0; visibility: hidden;
            transform: translateY(10px); transition: all 0.2s ease; min-width: 200px;
        }
        .custom-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-dropdown button {
            width: 100%; text-align: left; padding: 10px 12px; border-radius: 6px;
            font-size: 0.9rem; color: #374151; transition: background-color 0.2s ease;
            display: flex; align-items: center; gap: 8px;
        }
        .custom-dropdown button:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-teal-100 min-h-screen flex flex-col">
    <!-- Overlay Loading dengan Detail -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loadingText" class="loading-text">Memuat...</p>
        <p id="loadingDetails" class="loading-details"></p>
    </div>

    <!-- Modal Pesan Kustom -->
    <div id="messageModal" class="message-modal">
        <div class="message-modal-content">
            <div id="messageModalIcon" class="message-modal-icon"></div>
            <h3 id="messageModalTitle" class="message-modal-title"></h3>
            <p id="messageModalBody" class="message-modal-body"></p>
            <div id="messageModalActions" class="flex justify-center gap-3">
                <button id="messageModalConfirmButton" class="message-modal-button"></button>
                <button id="messageModalCancelButton" class="message-modal-button"></button>
            </div>
        </div>
    </div>

    <!-- Halaman Login -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <img src="https://i.imgur.com/0IzeRMf.png" alt="Logo Madrasah Nurul Yusuf" class="h-20 w-20 mx-auto mb-4 object-contain">
                <h1 class="text-3xl font-bold text-emerald-800 mb-2">Login Guru</h1>
                <h2 class="text-xl font-semibold text-emerald-600">Madrasah Diniyah Nurul Yusuf</h2>
            </div>
            <form id="loginForm"> 
                <div class="mb-4"><input type="email" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Masukkan email" required></div>
                <div class="mb-6"><input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Masukkan password" required></div>
                <button type="submit" class="w-full bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 font-semibold mt-4">Login</button>
            </form>
            <p class="text-xs text-gray-500 text-center mt-6">&copy; 2025 Madrasah Diniyah Nurul Yusuf.</p>
        </div>
    </div>

    <!-- Aplikasi Utama -->
    <div id="mainApp" class="hidden flex-grow flex flex-col">
        <!-- Navigasi -->
        <nav class="bg-emerald-500 text-white p-4 shadow-lg">
            <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
                <div class="flex items-center gap-4 mb-2 sm:mb-0">
                    <img src="https://i.imgur.com/0IzeRMf.png" alt="Logo" class="h-10 w-10 rounded-full object-contain">
                    <div>
                        <h1 class="text-xl font-bold">Madrasah Diniyah Nurul Yusuf</h1>
                        <p class="text-emerald-100 text-sm">Ahlan wa sahlan, <span id="currentUser"></span></p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 sm:gap-4 w-full sm:w-auto justify-center sm:justify-end mt-2 sm:mt-0">
                    <button id="attendanceBtn" class="px-4 py-2 rounded-lg bg-emerald-700">Absensi</button>
                    <button id="dashboardBtn" class="px-4 py-2 rounded-lg hover:bg-emerald-600">Rekapan Absen</button>
                    <button id="logoutBtn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700">Logout</button>
                </div>
            </div>
        </nav>

        <!-- Halaman Absensi -->
        <div id="attendancePage" class="container mx-auto px-4 py-8 flex-grow">
            <div class="bg-white rounded-lg shadow-md p-4 mb-6 flex flex-col sm:flex-row gap-4 items-center justify-center">
                <input type="date" id="attendanceDate" class="px-3 py-2 border rounded-lg">
                <div class="text-center">
                    <p class="text-lg font-medium text-gray-700" id="displayDate"></p>
                    <p class="text-sm text-gray-500" id="dayName"></p>
                </div>
                <button id="setTodayBtn" class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200 font-medium">Hari Ini</button>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Tambah Santri Baru</h3>
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <div class="md:col-span-6"><input type="text" id="studentName" placeholder="Nama lengkap santri" class="w-full px-4 py-3 border rounded-lg"></div>
                    <div class="md:col-span-3">
                        <select id="studentClass" class="w-full px-4 py-3 border rounded-lg">
                            <option value="">Pilih Kelas</option>
                            <option value="Ar Rahman">Ar Rahman</option><option value="Al Fattah">Al Fattah</option><option value="Al Mubdi'">Al Mubdi'</option>
                            <option value="Al Hijrah">Al Hijrah</option><option value="At Taubah">At Taubah</option><option value="Al Hafid">Al Hafid</option>
                        </select>
                    </div>
                    <div class="md:col-span-3"><button id="addStudentBtn" class="w-full h-full px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold">Tambah</button></div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-3 text-center text-xs font-semibold uppercase w-12">No</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Nama Santri</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase w-28">Kelas</th>
                                <th class="px-2 py-3 text-center text-xs font-semibold uppercase w-16">Hadir</th>
                                <th class="px-2 py-3 text-center text-xs font-semibold uppercase w-16">Sakit</th>
                                <th class="px-2 py-3 text-center text-xs font-semibold uppercase w-16">Izin</th>
                                <th class="px-2 py-3 text-center text-xs font-semibold uppercase w-16">Alpha</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase w-48">Keterangan</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase w-24">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                    <h4 class="text-lg font-semibold mb-4">Ringkasan Hari Ini</h4>
                    <div class="grid grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-emerald-50 rounded-lg"><div class="text-3xl font-bold text-emerald-600" id="hadirCount">0</div><div class="text-sm font-medium text-emerald-700">Hadir</div></div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg"><div class="text-3xl font-bold text-blue-600" id="sakitCount">0</div><div class="text-sm font-medium text-blue-700">Sakit</div></div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg"><div class="text-3xl font-bold text-yellow-600" id="izinCount">0</div><div class="text-sm font-medium text-yellow-700">Izin</div></div>
                        <div class="text-center p-4 bg-red-50 rounded-lg"><div class="text-3xl font-bold text-red-600" id="alphaCount">0</div><div class="text-sm font-medium text-red-700">Alpha</div></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 flex flex-col justify-center">
                    <button id="saveAttendanceBtn" class="w-full px-6 py-4 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold text-lg">Simpan Absensi</button>
                </div>
            </div>
        </div>

        <!-- Halaman Dashboard -->
        <div id="dashboardPage" class="hidden container mx-auto px-4 py-8 flex-grow">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Rekapan</h2>
            
            <!-- Tabel Rekapitulasi -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 bg-emerald-600 text-white"><h3 class="text-xl font-semibold">Rekapitulasi Absensi per Santri</h3></div>
                <div class="p-4 bg-gray-50 border-b">
                    <div class="flex flex-col md:flex-row gap-4 items-center">
                        <input type="text" id="summarySearchInput" placeholder="Cari nama atau kelas santri..." class="w-full md:flex-grow pl-4 pr-4 py-2 border rounded-lg">
                        <div class="flex gap-2 relative flex-wrap justify-center">
                             <button id="printReportBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">Cetak Laporan</button>
                             <div id="printReportDropdown" class="custom-dropdown">
                                <button id="printWordReportBtn"><svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm5.5 14H7.5V9.5h2V16zm3-4.5H10v-2h2.5a1.5 1.5 0 010 3zm-3-3.5H7.5V6h5a1.5 1.5 0 010 3H10V8z" clip-rule="evenodd"></path></svg>Format Word</button>
                                <button id="printSpreadsheetReportBtn"><svg class="w-5 h-5 text-emerald-600" fill="currentColor" viewBox="0 0 20 20"><path d="M2 2a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V4a2 2 0 00-2-2H2zm8.5 3.5a.5.5 0 01.5.5v2a.5.5 0 01-1 0v-2a.5.5 0 01.5-.5zM9 9a1 1 0 112 0v4a1 1 0 11-2 0V9zm-3 2.5a.5.5 0 01.5-.5h1a.5.5 0 01.5.5v1a.5.5 0 01-.5.5h-1a.5.5 0 01-.5-.5v-1zm4 0a.5.5 0 01.5-.5h1a.5.5 0 01.5.5v1a.5.5 0 01-.5.5h-1a.5.5 0 01-.5-.5v-1z"></path></svg>Format Spreadsheet</button>
                             </div>
                             <button id="mainExportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Ekspor</button>
                             <div id="exportOptionsDropdown" class="custom-dropdown">
                                <button id="exportJsonDataBtn"><svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>Data JSON</button>
                             </div>
                             <button id="importDataBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">Impor</button>
                             <button id="resetAttendanceCountsBtn" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium">Reset Absensi</button>
                             <input type="file" id="importFileInput" class="hidden" accept=".json">
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-3 text-center text-xs font-semibold uppercase w-12">No</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Nama Santri</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase w-28">Kelas</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase w-20">Hadir</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase w-20">Sakit</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase w-20">Izin</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase w-20">Alpha</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tabel Detail Absensi Harian -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden mt-8">
                <div class="px-6 py-4 bg-emerald-600 text-white"><h3 class="text-xl font-semibold">Detail Absensi Harian</h3></div>
                <div class="p-4 bg-gray-50 border-b">
                    <input type="text" id="detailedAttendanceSearchInput" placeholder="Cari nama, tanggal (YYYY-MM-DD), kelas, atau status..." class="w-full pl-4 pr-4 py-2 border rounded-lg">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-3 text-center text-xs font-semibold uppercase w-12">No</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Tanggal</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Nama Santri</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase">Kelas</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold uppercase">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="detailedAttendanceTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <footer class="bg-gray-800 text-gray-300 py-4 mt-auto">
            <div class="container mx-auto px-4 text-center text-sm"><p>&copy; 2025 Madrasah Diniyah Nurul Yusuf.</p></div>
        </footer>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, onSnapshot, query, addDoc, getDocs, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyCoSrJb8Gu9wOj85WRcGKfasRqP4BFi1F4",
                authDomain: "absensi-madinny.firebaseapp.com",
                projectId: "absensi-madinny",
                storageBucket: "absensi-madinny.firebasestorage.app",
                messagingSenderId: "770096586500",
                appId: "1:770096586500:web:3787b57c9ac638570ffa51"
            };

            let app, db, auth;
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                showErrorMessage('Gagal Inisialisasi Firebase: ' + e.message);
            }

            const appState = {
                currentUser: null,
                currentDisplayName: 'Guru',
                savedStudents: [],
                attendanceData: [],
                currentAttendanceDate: getTodayWIB()
            };

            // --- UI Helpers (Modal, Loading) ---
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingDetails = document.getElementById('loadingDetails');
            const messageModal = document.getElementById('messageModal');

            function showLoading(text = 'Memuat...', details = '') {
                loadingText.textContent = text;
                loadingDetails.textContent = details;
                loadingOverlay.classList.add('show');
            }
            function hideLoading() {
                loadingOverlay.classList.remove('show');
            }

            function hideMessageModal() {
                messageModal.classList.remove('show');
            }

            function showMessageModal(type, title, message, confirmText = 'OK', cancelText = '', onConfirm = null, onCancel = null) {
                const iconContainer = document.getElementById('messageModalIcon');
                const titleEl = document.getElementById('messageModalTitle');
                const bodyEl = document.getElementById('messageModalBody');
                const confirmBtn = document.getElementById('messageModalConfirmButton');
                const cancelBtn = document.getElementById('messageModalCancelButton');

                titleEl.textContent = title;
                bodyEl.textContent = message;

                const icons = {
                    success: `<svg class="w-12 h-12 text-emerald-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                    error: `<svg class="w-12 h-12 text-red-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                    confirm: `<svg class="w-12 h-12 text-yellow-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9.247a4.5 4.5 0 000 5.506m0 0l-1.5 1.5m1.5-1.5l1.5 1.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
                };
                iconContainer.innerHTML = icons[type] || '';

                confirmBtn.textContent = confirmText;
                confirmBtn.className = `message-modal-button ${type === 'error' ? 'error' : 'success'}`;
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    hideMessageModal();
                };

                if (cancelText) {
                    cancelBtn.textContent = cancelText;
                    cancelBtn.className = 'message-modal-button cancel';
                    cancelBtn.classList.remove('hidden');
                    cancelBtn.onclick = () => {
                        if (onCancel) onCancel();
                        hideMessageModal();
                    };
                } else {
                    cancelBtn.classList.add('hidden');
                }
                
                messageModal.classList.add('show');
            }
            function showSuccessMessage(message) { showMessageModal('success', 'Berhasil!', message); }
            function showErrorMessage(message) { showMessageModal('error', 'Terjadi Kesalahan!', message); }

            // --- Core App Logic ---
            function getTodayWIB() {
                const now = new Date();
                const wibDate = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Jakarta' }));
                return wibDate.toISOString().split('T')[0];
            }
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    appState.currentUser = user.uid;
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    initializeAppLogic();
                } else {
                    appState.currentUser = null;
                    document.getElementById('mainApp').classList.add('hidden');
                    document.getElementById('loginPage').classList.remove('hidden');
                }
            });

            async function initializeAppLogic() {
                showLoading('Memuat data...');
                await setupFirestoreListeners();
                const displayName = await getDisplayName(appState.currentUser);
                appState.currentDisplayName = displayName;
                document.getElementById('currentUser').textContent = displayName;
                document.getElementById('attendanceDate').value = appState.currentAttendanceDate;
                updateDateDisplay();
                hideLoading();
            }

            async function getDisplayName(uid) {
                const userProfileRef = doc(db, `users/${uid}/profile/info`);
                try {
                    const docSnap = await getDoc(userProfileRef);
                    return docSnap.exists() && docSnap.data().displayName ? docSnap.data().displayName : 'Guru';
                } catch (error) { console.error("Error fetching display name:", error); return 'Guru'; }
            }
            
            function setupFirestoreListeners() {
                if (!appState.currentUser) return;
                const studentsQuery = collection(db, `users/${appState.currentUser}/students`);
                onSnapshot(studentsQuery, (snapshot) => {
                    appState.savedStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.nama.localeCompare(b.nama));
                    renderStudentTable();
                    updateSummaryTable();
                }, err => showErrorMessage("Gagal memuat data santri: " + err.message));

                const attendanceQuery = collection(db, `users/${appState.currentUser}/attendance`);
                onSnapshot(attendanceQuery, (snapshot) => {
                    appState.attendanceData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateSummaryTable();
                    renderDetailedAttendanceTable();
                    restoreAttendanceState(appState.currentAttendanceDate);
                }, err => showErrorMessage("Gagal memuat data absensi: " + err.message));
            }

            function updateDateDisplay() {
                const dateInput = document.getElementById('attendanceDate');
                if (!dateInput.value) return;
                const selectedDate = new Date(dateInput.value + 'T00:00:00');
                document.getElementById('displayDate').textContent = selectedDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('dayName').textContent = selectedDate.toLocaleDateString('id-ID', { weekday: 'long' });
            }

            // --- Attendance Page Logic ---
            function renderStudentTable() {
                const tableBody = document.getElementById('studentTableBody');
                tableBody.innerHTML = appState.savedStudents.length > 0 
                    ? appState.savedStudents.map(createStudentRowHtml).join('')
                    : `<tr><td colspan="9" class="p-8 text-center text-gray-500">Belum ada santri.</td></tr>`;
                restoreAttendanceState(appState.currentAttendanceDate);
            }

            function createStudentRowHtml(student, index) {
                return `
                    <tr class="hover:bg-gray-50" data-student-id="${student.id}">
                        <td class="px-2 py-3 text-sm text-center">${index + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium">${student.nama}</td>
                        <td class="px-4 py-3 text-sm text-center">${student.kelas}</td>
                        <td class="px-2 py-3 text-center"><input type="radio" name="attendance_${student.id}" value="hadir" class="w-4 h-4 text-emerald-600"></td>
                        <td class="px-2 py-3 text-center"><input type="radio" name="attendance_${student.id}" value="sakit" class="w-4 h-4 text-blue-600"></td>
                        <td class="px-2 py-3 text-center"><input type="radio" name="attendance_${student.id}" value="izin" class="w-4 h-4 text-yellow-600"></td>
                        <td class="px-2 py-3 text-center"><input type="radio" name="attendance_${student.id}" value="alpha" class="w-4 h-4 text-red-600"></td>
                        <td class="px-4 py-3"><input type="text" placeholder="Keterangan..." class="w-full px-2 py-1 text-sm border rounded-lg"></td>
                        <td class="px-4 py-3 text-center">
                            <button data-action="delete-student" data-student-id="${student.id}" data-student-name="${student.nama}" class="px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm">Hapus</button>
                        </td>
                    </tr>`;
            }
            
            function restoreAttendanceState(date) {
                appState.savedStudents.forEach(student => {
                    const record = appState.attendanceData.find(r => r.studentId === student.id && r.tanggal === date);
                    const row = document.querySelector(`tr[data-student-id="${student.id}"]`);
                    if (row) {
                        row.querySelectorAll(`input[name="attendance_${student.id}"]`).forEach(r => r.checked = false);
                        row.querySelector('input[type="text"]').value = record?.keterangan || '';
                        if (record) {
                            const radio = row.querySelector(`input[value="${record.status}"]`);
                            if (radio) radio.checked = true;
                        }
                    }
                });
                updateSummary();
            }

            function updateSummary() {
                const counts = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
                document.querySelectorAll('#studentTableBody tr[data-student-id]').forEach(row => {
                    const radio = row.querySelector('input[type="radio"]:checked');
                    if (radio) counts[radio.value]++;
                });
                document.getElementById('hadirCount').textContent = counts.hadir;
                document.getElementById('sakitCount').textContent = counts.sakit;
                document.getElementById('izinCount').textContent = counts.izin;
                document.getElementById('alphaCount').textContent = counts.alpha;
            }

            async function addStudent() {
                const nameInput = document.getElementById('studentName');
                const classSelect = document.getElementById('studentClass');
                const nama = nameInput.value.trim();
                const kelas = classSelect.value;
                if (!nama || !kelas) return showErrorMessage('Nama dan kelas wajib diisi!');
                
                showLoading('Menambah santri...');
                try {
                    await addDoc(collection(db, `users/${appState.currentUser}/students`), { nama, kelas });
                    nameInput.value = '';
                    classSelect.value = '';
                    nameInput.focus();
                    showSuccessMessage(`Santri "${nama}" berhasil ditambahkan.`);
                } catch (error) {
                    showErrorMessage('Gagal menambah santri: ' + error.message);
                } finally {
                    hideLoading();
                }
            }

            function deleteStudent(id, nama) {
                showMessageModal('confirm', 'Konfirmasi Hapus', `Yakin hapus santri: ${nama}?\nSemua data absensinya juga akan terhapus!`, 'Ya, Hapus', 'Batal', async () => {
                    showLoading('Menghapus santri...');
                    try {
                        await deleteDoc(doc(db, `users/${appState.currentUser}/students`, id));
                        const q = query(collection(db, `users/${appState.currentUser}/attendance`), where("studentId", "==", id));
                        const snapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        snapshot.forEach(docSnap => batch.delete(docSnap.ref));
                        await batch.commit();
                        showSuccessMessage(`Santri ${nama} berhasil dihapus.`);
                    } catch (error) {
                        showErrorMessage('Gagal menghapus santri: ' + error.message);
                    } finally {
                        hideLoading();
                    }
                });
            }

            async function saveAttendance() {
                showLoading('Menyimpan absensi...');
                const date = appState.currentAttendanceDate;
                const updates = [];
                document.querySelectorAll('#studentTableBody tr[data-student-id]').forEach(row => {
                    const studentId = row.dataset.studentId;
                    const statusRadio = row.querySelector('input[type="radio"]:checked');
                    if (statusRadio) {
                        const student = appState.savedStudents.find(s => s.id === studentId);
                        updates.push({
                            studentId, tanggal: date, nama: student.nama, kelas: student.kelas,
                            status: statusRadio.value, keterangan: row.querySelector('input[type="text"]').value.trim(),
                            timestamp: new Date().toISOString()
                        });
                    }
                });

                if (updates.length === 0) {
                    hideLoading();
                    return showErrorMessage('Tidak ada data absensi untuk disimpan.');
                }
                
                try {
                    const batch = writeBatch(db);
                    const attendanceColRef = collection(db, `users/${appState.currentUser}/attendance`);
                    for (const record of updates) {
                        const q = query(attendanceColRef, where("studentId", "==", record.studentId), where("tanggal", "==", record.tanggal));
                        const snapshot = await getDocs(q);
                        if (!snapshot.empty) {
                            snapshot.forEach(docSnap => batch.update(docSnap.ref, record));
                        } else {
                            batch.set(doc(attendanceColRef), record);
                        }
                    }
                    await batch.commit();
                    showSuccessMessage('Absensi berhasil disimpan!');
                } catch (error) {
                    showErrorMessage('Gagal menyimpan absensi: ' + error.message);
                } finally {
                    hideLoading();
                }
            }

            // --- Dashboard Logic ---
            function updateSummaryTable(filteredStudents = null) {
                const tableBody = document.getElementById('summaryTableBody');
                const studentsToShow = filteredStudents || appState.savedStudents;
                
                tableBody.innerHTML = studentsToShow.length > 0 ? studentsToShow.map((student, index) => {
                    const counts = appState.attendanceData.filter(d => d.studentId === student.id)
                        .reduce((acc, {status}) => { acc[status] = (acc[status] || 0) + 1; return acc; }, { hadir: 0, sakit: 0, izin: 0, alpha: 0 });
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-2 py-3 text-sm text-center">${index + 1}</td>
                            <td class="px-4 py-3 text-sm font-medium">${student.nama}</td>
                            <td class="px-4 py-3 text-sm text-center">${student.kelas}</td>
                            <td class="px-4 py-3 text-sm text-emerald-700 text-center font-semibold">${counts.hadir}</td>
                            <td class="px-4 py-3 text-sm text-blue-700 text-center font-semibold">${counts.sakit}</td>
                            <td class="px-4 py-3 text-sm text-yellow-700 text-center font-semibold">${counts.izin}</td>
                            <td class="px-4 py-3 text-sm text-red-700 text-center font-semibold">${counts.alpha}</td>
                        </tr>`;
                }).join('') : `<tr><td colspan="7" class="p-8 text-center text-gray-500">Tidak ada data.</td></tr>`;
            }
            
            function renderDetailedAttendanceTable(filteredRecords = null) {
                const tableBody = document.getElementById('detailedAttendanceTableBody');
                const recordsToShow = (filteredRecords || appState.attendanceData).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

                tableBody.innerHTML = recordsToShow.length > 0 ? recordsToShow.map((record, index) => {
                    const statusColors = { hadir: 'text-emerald-700', sakit: 'text-blue-700', izin: 'text-yellow-700', alpha: 'text-red-700' };
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-2 py-3 text-sm text-center">${index + 1}</td>
                            <td class="px-4 py-3 text-sm">${new Date(record.tanggal + 'T00:00:00').toLocaleDateString('id-ID')}</td>
                            <td class="px-4 py-3 text-sm">${record.nama}</td>
                            <td class="px-4 py-3 text-sm text-center">${record.kelas}</td>
                            <td class="px-4 py-3 text-sm text-center font-semibold ${statusColors[record.status] || ''}">${record.status}</td>
                            <td class="px-4 py-3 text-sm">${record.keterangan || '-'}</td>
                        </tr>`;
                }).join('') : `<tr><td colspan="6" class="p-8 text-center text-gray-500">Tidak ada catatan absensi.</td></tr>`;
            }

            // --- Import/Export/Report Logic ---
            function exportJsonData() {
                const exportObject = { students: appState.savedStudents, attendance: appState.attendanceData };
                const blob = new Blob([JSON.stringify(exportObject, null, 2)], { type: 'application/json' });
                saveAs(blob, `absensi_data_${getTodayWIB()}.json`);
                showSuccessMessage('Data JSON berhasil diekspor.');
            }

            async function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.students || !importedData.attendance) throw new Error('Struktur file JSON tidak valid.');
                        
                        showMessageModal('confirm', 'Konfirmasi Impor', 'Impor akan menghapus semua data saat ini dan menggantinya dengan data dari file. Lanjutkan?', 'Ya, Impor', 'Batal', async () => {
                            const { students, attendance } = importedData;
                            const BATCH_SIZE = 400;

                            try {
                                showLoading('Mengimpor Data', 'Menghapus data lama...');
                                const collections = [collection(db, `users/${appState.currentUser}/students`), collection(db, `users/${appState.currentUser}/attendance`)];
                                for (const collRef of collections) {
                                    const snapshot = await getDocs(collRef);
                                    const deleteBatch = writeBatch(db);
                                    snapshot.docs.forEach(d => deleteBatch.delete(d.ref));
                                    await deleteBatch.commit();
                                }

                                showLoading('Mengimpor Data', 'Mengimpor data santri...');
                                for (let i = 0; i < students.length; i += BATCH_SIZE) {
                                    const batch = writeBatch(db);
                                    const chunk = students.slice(i, i + BATCH_SIZE);
                                    chunk.forEach(student => {
                                        const { id, ...studentData } = student;
                                        batch.set(doc(db, `users/${appState.currentUser}/students`, id), studentData);
                                    });
                                    showLoading('Mengimpor Data', `Proses santri (${i + chunk.length}/${students.length})...`);
                                    await batch.commit();
                                }

                                showLoading('Mengimpor Data', 'Mengimpor data absensi...');
                                for (let i = 0; i < attendance.length; i += BATCH_SIZE) {
                                    const batch = writeBatch(db);
                                    const chunk = attendance.slice(i, i + BATCH_SIZE);
                                    chunk.forEach(record => {
                                        const { id, ...recordData } = record;
                                        batch.set(doc(db, `users/${appState.currentUser}/attendance`, id), recordData);
                                    });
                                    showLoading('Mengimpor Data', `Proses absensi (${i + chunk.length}/${attendance.length})...`);
                                    await batch.commit();
                                }
                                showSuccessMessage('Data berhasil diimpor!');
                            } catch (error) {
                                showErrorMessage('Gagal saat proses impor: ' + error.message);
                            } finally {
                                hideLoading();
                            }
                        });
                    } catch (error) {
                        showErrorMessage('Gagal membaca file: ' + error.message);
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            }
            
            function resetAttendanceCounts() {
                showMessageModal('confirm', 'Konfirmasi Reset', 'Yakin ingin menghapus SEMUA data absensi? Tindakan ini tidak dapat dibatalkan.', 'Ya, Hapus Semua', 'Batal', async () => {
                    showLoading('Mereset data absensi...');
                    try {
                        const attendanceColRef = collection(db, `users/${appState.currentUser}/attendance`);
                        const snapshot = await getDocs(attendanceColRef);
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(docSnap => batch.delete(docSnap.ref));
                        await batch.commit();
                        showSuccessMessage('Semua data absensi berhasil direset!');
                    } catch (error) {
                        showErrorMessage('Gagal mereset absensi: ' + error.message);
                    } finally {
                        hideLoading();
                    }
                });
            }

            function generateReport(format) {
                const { Packer, Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType } = docx;
                const { students, attendance, currentDisplayName } = appState;
                let className = students.length > 0 && students.every(s => s.kelas === students[0].kelas) ? students[0].kelas : "Berbagai Kelas";
                const reportData = students.map(student => ({
                    nama: student.nama,
                    ...attendance.filter(d => d.studentId === student.id).reduce((acc, {status}) => { acc[status] = (acc[status] || 0) + 1; return acc; }, { hadir: 0, sakit: 0, izin: 0, alpha: 0 })
                }));

                if (format === 'spreadsheet') {
                    let csvContent = `Laporan Absensi\nNama Guru,${currentDisplayName}\nKelas,${className}\n\nNo,Nama Santri,Hadir,Sakit,Izin,Alpha\n`;
                    reportData.forEach((row, i) => { csvContent += `${i + 1},"${row.nama}",${row.hadir},${row.sakit},${row.izin},${row.alpha}\n`; });
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    saveAs(blob, `laporan_absensi_${className}_${getTodayWIB()}.csv`);
                } else {
                    const tableHeader = new TableRow({ children: [ "No", "Nama Santri", "Hadir", "Sakit", "Izin", "Alpha" ].map(text => new TableCell({ children: [new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text, bold: true })]})] })) });
                    const tableRows = reportData.map((row, i) => new TableRow({ children: [
                        new TableCell({ children: [new Paragraph({ text: `${i + 1}`, alignment: AlignmentType.CENTER })] }),
                        new TableCell({ children: [new Paragraph(row.nama)] }),
                        new TableCell({ children: [new Paragraph({ text: `${row.hadir}`, alignment: AlignmentType.CENTER })] }),
                        new TableCell({ children: [new Paragraph({ text: `${row.sakit}`, alignment: AlignmentType.CENTER })] }),
                        new TableCell({ children: [new Paragraph({ text: `${row.izin}`, alignment: AlignmentType.CENTER })] }),
                        new TableCell({ children: [new Paragraph({ text: `${row.alpha}`, alignment: AlignmentType.CENTER })] }),
                    ]}));
                    const doc = new Document({ sections: [{ children: [
                        new Paragraph({ children: [new TextRun({ text: "Laporan Absensi", bold: true, size: 32 })], alignment: AlignmentType.CENTER }),
                        new Paragraph(`Nama Guru: ${currentDisplayName}`), new Paragraph(`Kelas: ${className}`), new Paragraph(""),
                        new Table({ rows: [tableHeader, ...tableRows], width: { size: 100, type: WidthType.PERCENTAGE } }),
                    ]}]});
                    Packer.toBlob(doc).then(blob => saveAs(blob, `laporan_absensi_${className}_${getTodayWIB()}.docx`));
                }
            }

            // --- Event Listeners ---
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading('Login...');
                try {
                    await signInWithEmailAndPassword(auth, document.getElementById('username').value, document.getElementById('password').value);
                } catch (error) { showErrorMessage('Login gagal: ' + error.message); } 
                finally { hideLoading(); }
            });

            document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
            document.getElementById('attendanceBtn').addEventListener('click', () => {
                document.getElementById('attendancePage').classList.remove('hidden');
                document.getElementById('dashboardPage').classList.add('hidden');
                document.getElementById('attendanceBtn').classList.add('bg-emerald-700');
                document.getElementById('dashboardBtn').classList.remove('bg-emerald-600');
            });
            document.getElementById('dashboardBtn').addEventListener('click', () => {
                document.getElementById('dashboardPage').classList.remove('hidden');
                document.getElementById('attendancePage').classList.add('hidden');
                document.getElementById('dashboardBtn').classList.add('bg-emerald-700');
                document.getElementById('attendanceBtn').classList.remove('bg-emerald-700');
            });
            
            document.getElementById('attendanceDate').addEventListener('change', (e) => {
                appState.currentAttendanceDate = e.target.value;
                updateDateDisplay();
                restoreAttendanceState(appState.currentAttendanceDate);
            });
            document.getElementById('setTodayBtn').addEventListener('click', () => {
                document.getElementById('attendanceDate').value = getTodayWIB();
                document.getElementById('attendanceDate').dispatchEvent(new Event('change'));
            });

            document.getElementById('addStudentBtn').addEventListener('click', addStudent);
            document.getElementById('saveAttendanceBtn').addEventListener('click', saveAttendance);

            document.getElementById('studentTableBody').addEventListener('click', (e) => {
                if (e.target.closest('[data-action="delete-student"]')) {
                    const btn = e.target.closest('[data-action="delete-student"]');
                    deleteStudent(btn.dataset.studentId, btn.dataset.studentName);
                }
            });
            document.getElementById('studentTableBody').addEventListener('change', e => { if (e.target.type === 'radio') updateSummary(); });

            document.getElementById('summarySearchInput').addEventListener('keyup', (e) => {
                const term = e.target.value.toLowerCase();
                updateSummaryTable(appState.savedStudents.filter(s => s.nama.toLowerCase().includes(term) || s.kelas.toLowerCase().includes(term)));
            });
            document.getElementById('detailedAttendanceSearchInput').addEventListener('keyup', (e) => {
                const term = e.target.value.toLowerCase();
                renderDetailedAttendanceTable(appState.attendanceData.filter(r => Object.values(r).some(val => String(val).toLowerCase().includes(term))));
            });
            
            function setupDropdown(triggerId, dropdownId) {
                const trigger = document.getElementById(triggerId);
                const dropdown = document.getElementById(dropdownId);
                trigger.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); });
                document.addEventListener('click', (e) => { if (!dropdown.contains(e.target) && !trigger.contains(e.target)) dropdown.classList.remove('show'); });
            }
            setupDropdown('mainExportBtn', 'exportOptionsDropdown');
            setupDropdown('printReportBtn', 'printReportDropdown');

            document.getElementById('exportJsonDataBtn').addEventListener('click', exportJsonData);
            document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
            document.getElementById('importFileInput').addEventListener('change', importData);
            document.getElementById('resetAttendanceCountsBtn').addEventListener('click', resetAttendanceCounts);
            
            document.getElementById('printWordReportBtn').addEventListener('click', () => generateReport('word'));
            document.getElementById('printSpreadsheetReportBtn').addEventListener('click', () => generateReport('spreadsheet'));

        </script>
    </body>
</html>
