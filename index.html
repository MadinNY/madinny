<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Madrasah Diniyah Nurul Yusuf</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQWJzZW5zaSBNYWRyYXNhaCBEaW5peWFoIE51cnVsIFl1c3VmIiwic2hvcnRfbmFtZSI6IkFic2Vuc2kgTWFkcmFzYWgiLCJzdG9ydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMxMGI5ODEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTWpRaUlHaGxhV2RvZEQwaU1qUWlJSFpwWlhkQ2IzZzlJakFnTUNBeU5DQXlOQ0lnWm1sc2JEMGlJekV3WWprNE1TSStQSEJoZEdnaVpEMGlUVEV5SURKRFFqRXlJREV1TlRNMklERXhMalEySURJdU1EUWdNVEV1TkRZZ01pNDFORU14TVM0ME5pQXpMakEwSURFeUlETWdNVElnTTBNeE1pNDFORU14TWk0MU5DQXpMakEwSURFekxqVTBJREl1TURRZ01UTWdNa014TXk0MU5DQXhMalUwSURFeUxqVTBJREVnTVRJZ01VTXhNUzQxTmlBeElERXhJREV1TlRNMklERXdMalUwSURJdU1EUWdNVEFnTWk0MU5FTTVMalEySURNdU1EUWdPUzQxTkNBN0xqVTBJRGdnTkVNNElEUXVORFlnT0M0MU5DQTFMalUwSURrZ05rTTVMalUwSURZdU5EWWdNVEFnTnk0MU5DQXhNUzQxTmlBNElERXlJRGhETVRJdU5EWWdPUzQxTkNBeE15QTNMalUwSURFMElEWkRNVFFnTkM0ME5pQXhOQzQxTkNBekxqVTBJREUwSURKRE1UUWdNUzQxTkNBeE15NDFOQ0F4SURFeUlERmFJaTgrUEM5emRtYysifSx7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU5EZ2lJR2hsYVdkb2REMGlORGdpSUhacFpYZENiM2c5SWpBZ01DQTBPQ0EwT0NJZ1ptbHNiRDBpSXpFd1lqazRNU0krUEhCaGRHZ2daRDBpVFRJMElEUkRNalFnTVM0NU5qZ2dNak11TURNeUlERWdNakVnTVVNeE9TNHdOamdnTVNBeU5pNDVOamdnTVM0NU5qZ2dNVFlnTkVNMVRqRXVPVFk0SURFMklERWdNVGtnTVNBeU5DQXhRekkyTGprek1pQXhJREkwSURFdU9UWTRJREkwSURSYUlpOCtQQzl6ZG1jKyIsInNpemVzIjoiNDh4NDgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <meta name="theme-color" content="#10b981">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .access-code { 
            background: linear-gradient(45deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        /* Custom Message Box Styles */
        .message-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .message-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .message-modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .message-modal.show .message-modal-content {
            transform: translateY(0);
        }
        .message-modal-icon {
            margin-bottom: 16px;
        }
        .message-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .message-modal-body {
            font-size: 0.95rem;
            color: #4a5568;
            margin-bottom: 24px;
        }
        .message-modal-button {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .message-modal-button.success {
            background: #10b981;
            color: white;
        }
        .message-modal-button.success:hover {
            background: #059669;
        }
        .message-modal-button.error {
            background: #ef4444;
            color: white;
        }
        .message-modal-button.error:hover {
            background: #dc2626;
        }

        /* Offline indicator styles */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f59e0b;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .offline-indicator.show {
            transform: translateY(0);
        }
        
        .offline-indicator.online {
            background: #10b981;
        }
        
        /* PWA install button */
        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .install-button:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }
        
        .install-button.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-teal-100 min-h-screen">
    <!-- Offline/Online Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
        <span id="connectionStatus">Tidak ada koneksi internet - Mode offline aktif</span>
    </div>
    
    <!-- PWA Install Button -->
    <button id="installButton" class="install-button">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Install App
    </button>
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-emerald-800 mb-2">Login Guru</h1>
                <h2 class="text-xl font-semibold text-emerald-600">Madrasah Diniyah Nurul Yusuf</h2>
                <div class="w-16 h-1 bg-emerald-500 mx-auto mt-4 rounded-full"></div>
            </div>
            
            <form onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Username</label>
                    <input 
                        type="text" 
                        id="username" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                        placeholder="Masukkan username"
                        required
                    >
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                    <input 
                        type="password" 
                        id="password" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                        placeholder="Masukkan password"
                        required
                    >
                </div>
                
                <!-- Error Message -->
                <div id="errorMessage" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="errorText"></span>
                    </div>
                    <button onclick="hideError()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                        Coba Lagi
                    </button>
                </div>
                
                <button 
                    type="submit" 
                    class="w-full bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition-colors font-semibold"
                >
                    Login
                </button>
            </form>
            

            
            <div class="mt-4 p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                <p class="text-xs text-emerald-700 text-center">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                    Link ini dapat dibagikan kepada guru lain
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="bg-emerald-600 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div>
                        <h1 class="text-xl font-bold">Madrasah Diniyah Nurul Yusuf</h1>
                        <p class="text-emerald-100 text-sm">Ahlan wa sahlan, <span id="currentUser"></span></p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button 
                        onclick="showPage('attendance')" 
                        id="attendanceBtn"
                        class="px-4 py-2 rounded-lg bg-emerald-700 hover:bg-emerald-800 transition-colors"
                    >
                        Absensi
                    </button>
                    <button 
                        onclick="showPage('dashboard')" 
                        id="dashboardBtn"
                        class="px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors"
                    >
                        Rekapan Absen
                    </button>
                    <button 
                        onclick="logout()" 
                        class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 transition-colors"
                    >
                        Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Attendance Page -->
        <div id="attendancePage" class="container mx-auto px-4 py-8">
            <!-- Date Selection -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 text-center">Pilih Tanggal Absensi</h3>
                <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Tanggal:</label>
                        <input 
                            type="date" 
                            id="attendanceDate" 
                            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                            onchange="updateDateDisplay()"
                        >
                    </div>
                    <div class="text-center">
                        <p class="text-lg font-medium text-gray-700" id="displayDate"></p>
                        <p class="text-sm text-gray-500" id="dayName"></p>
                    </div>
                    <button 
                        onclick="setToday()" 
                        class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200 transition-colors text-sm font-medium"
                    >
                        Hari Ini
                    </button>
                </div>
            </div>

            <!-- Add Student Form -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-3 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Tambah Santri Baru
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <div class="md:col-span-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Santri</label>
                        <input 
                            type="text" 
                            id="studentName" 
                            placeholder="Masukkan nama lengkap santri" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm"
                        >
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                        <input 
                            type="text" 
                            id="studentClass" 
                            placeholder="Contoh: 1A, 2B" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm"
                        >
                    </div>
                    <div class="md:col-span-3 flex items-end">
                        <button 
                            onclick="addStudent()" 
                            class="w-full px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-all duration-200 font-semibold text-sm shadow-md hover:shadow-lg flex items-center justify-center gap-2"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Tambah Santri
                        </button>
                    </div>
                </div>
            </div>

            <!-- Attendance Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-5 bg-emerald-600 text-white">
                    <h3 class="text-xl font-semibold">Daftar Absensi Santri</h3>
                    <p class="text-emerald-100 text-sm mt-1">Pilih status kehadiran untuk setiap santri</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-16">No</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider min-w-[200px]">Nama Santri</th>
                                <th class="px-4 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">Kelas</th>
                                <th class="px-4 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">
                                    <div class="flex flex-col items-center">
                                        <span class="text-emerald-600">‚úì</span>
                                        <span>Hadir</span>
                                    </div>
                                </th>
                                <th class="px-4 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">
                                    <div class="flex flex-col items-center">
                                        <span class="text-blue-600">üè•</span>
                                        <span>Sakit</span>
                                    </div>
                                </th>
                                <th class="px-4 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">
                                    <div class="flex flex-col items-center">
                                        <span class="text-yellow-600">üìù</span>
                                        <span>Izin</span>
                                    </div>
                                </th>
                                <th class="px-4 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">
                                    <div class="flex flex-col items-center">
                                        <span class="text-red-600">‚úó</span>
                                        <span>Alpha</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider min-w-[150px]">Keterangan</th>
                                <th class="px-4 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-24">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Students will be loaded from localStorage -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Summary and Save Button -->
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Ringkasan Absensi Hari Ini
                    </h4>
                    <div class="grid grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                            <div class="text-3xl font-bold text-emerald-600 mb-1" id="hadirCount">0</div>
                            <div class="text-sm font-medium text-emerald-700">Hadir</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-3xl font-bold text-blue-600 mb-1" id="sakitCount">0</div>
                            <div class="text-sm font-medium text-blue-700">Sakit</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div class="text-3xl font-bold text-yellow-600 mb-1" id="izinCount">0</div>
                            <div class="text-sm font-medium text-yellow-700">Izin</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg border border-red-200">
                            <div class="text-3xl font-bold text-red-600 mb-1" id="alphaCount">0</div>
                            <div class="text-sm font-medium text-red-700">Alpha</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 flex flex-col justify-center">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center">Simpan Data Absensi</h4>
                    <button 
                        onclick="saveAttendance()" 
                        class="w-full px-6 py-4 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-all duration-200 font-semibold text-lg shadow-md hover:shadow-lg flex items-center justify-center gap-3"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        Simpan Absensi
                    </button>
                    <p class="text-sm text-gray-500 text-center mt-3">Data akan tersimpan secara otomatis</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="container mx-auto px-4 py-8 hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Rekapan Absen</h2>
                <p class="text-gray-600">Ringkasan dan analisis kehadiran santri</p>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Santri</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalStudents">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-emerald-100 text-emerald-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Hadir</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalHadir">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Izin</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalIzin">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Sakit</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalSakit">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-red-100 text-red-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Alpha</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalAlpha">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export/Import Buttons -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                <button 
                    onclick="exportData()" 
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold shadow-md flex items-center justify-center gap-2 w-full sm:w-auto"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Ekspor Data
                </button>
                <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="handleImportFile(event)">
                <button 
                    onclick="document.getElementById('importFileInput').click()" 
                    class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold shadow-md flex items-center justify-center gap-2 w-full sm:w-auto"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    Impor Data
                </button>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Aktivitas Terbaru</h3>
                <div id="recentActivity" class="space-y-3">
                    <!-- Recent activities will be populated by JavaScript -->
                </div>
            </div>

            <!-- Student Summary Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                <div class="px-6 py-4 bg-gray-50 border-b">
                    <h3 class="text-lg font-semibold text-gray-800">Ringkasan Kehadiran Santri</h3>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Santri</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hadir</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Sakit</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Izin</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Alpha</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Summary data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Student Attendance Detail Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 bg-gray-50 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Rekapan Absensi Per Santri</h3>
                        <!-- Search Box -->
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="searchInput" 
                                    placeholder="Cari nama santri, tanggal, atau kelas..." 
                                    class="pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-sm w-72 shadow-sm"
                                    onkeyup="searchAttendance()"
                                >
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <button 
                                onclick="clearSearch()" 
                                class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium border border-gray-300 shadow-sm"
                            >
                                Reset
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-16">No</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-32">Tanggal</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider min-w-[200px]">Nama Santri</th>
                                <th class="px-4 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">Kelas</th>
                                <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-24">Status</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider min-w-[150px]">Keterangan</th>
                                <th class="px-4 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider w-20">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    // User credentials
    const users = {
        'rizqi': 'admin', // Mengganti 'dada' menjadi 'rizqi'
        'lilis': 'admin',
        'adit': 'admin',
        'dudu': 'admin'
    };

    let currentUser = null;
    let studentCounter = 0;
    let attendanceData = [];
    let attendanceChart = null;
    let savedStudents = [];

    // Login functionality
    function handleLogin(event) {
        event.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        if (users[username] && users[username] === password) {
            currentUser = username;
            
            // Add title based on username
            let displayName = username;
            if (username === 'adit') {
                displayName = 'Ustad Adit';
            } else if (username === 'lilis') {
                displayName = 'Ustadzah Lilis';
            } else if (username === 'rizqi') { // Menambahkan kondisi untuk 'rizqi'
                displayName = 'Ustad Rizqi';
            } else if (username === 'dudu') {
                displayName = 'Ustad Dudu';
            }
                
                document.getElementById('currentUser').textContent = displayName;
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                showPage('attendance');
                initializeApp();
            } else if (!users[username]) {
                showError('Username salah! Silakan periksa kembali username Anda.');
            } else {
                showError('Password salah! Silakan periksa kembali password Anda.');
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        // Hide error message
        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('username').focus();
        }

        // Logout functionality
        function logout() {
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Page navigation
        function showPage(page) {
            document.getElementById('attendancePage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            
            document.getElementById('attendanceBtn').classList.remove('bg-emerald-700');
            document.getElementById('dashboardBtn').classList.remove('bg-emerald-700');
            
            if (page === 'attendance') {
                document.getElementById('attendancePage').classList.remove('hidden');
                document.getElementById('attendanceBtn').classList.add('bg-emerald-700');
            } else if (page === 'dashboard') {
                document.getElementById('dashboardPage').classList.remove('hidden');
                document.getElementById('dashboardBtn').classList.add('bg-emerald-700');
                updateDashboard();
            }
        }

        // Initialize app
        function initializeApp() {
            setToday();
            loadSavedData();
            loadStudentsFromStorage();
            updateSummary();
            
            // Load saved summary after a short delay to ensure DOM is ready
            setTimeout(() => {
                loadSavedSummary();
            }, 100);
        }

        // Load saved data from localStorage for current user with backup recovery
        function loadSavedData() {
            let saved = localStorage.getItem(`attendanceData_${currentUser}`);
            
            // Try primary storage first
            if (saved) {
                try {
                    attendanceData = JSON.parse(saved);
                } catch (error) {
                    console.error('Primary attendance data corrupted, trying backup:', error);
                    saved = null;
                }
            }
            
            // Try backup storage if primary failed
            if (!saved) {
                const backupData = localStorage.getItem(`backup_attendance_${currentUser}`);
                if (backupData) {
                    try {
                        attendanceData = JSON.parse(backupData);
                        showSyncStatus('Data absensi dipulihkan dari backup', 'success');
                    } catch (error) {
                        console.error('Backup attendance data corrupted:', error);
                    }
                }
            }
            
            // Try global backup if both failed
            if (!attendanceData || attendanceData.length === 0) {
                try {
                    const globalBackup = JSON.parse(localStorage.getItem('globalBackup') || '{}');
                    if (globalBackup[currentUser] && globalBackup[currentUser].attendanceData) {
                        attendanceData = globalBackup[currentUser].attendanceData;
                        showSyncStatus('Data absensi dipulihkan dari backup global', 'success');
                    }
                } catch (error) {
                    console.error('Global backup attendance failed:', error);
                }
            }
            
            // Try emergency storage as last resort
            if (!attendanceData || attendanceData.length === 0) {
                try {
                    const emergency = JSON.parse(sessionStorage.getItem(`emergency_${currentUser}`) || '{}');
                    if (emergency.attendanceData) {
                        attendanceData = emergency.attendanceData;
                        showSyncStatus('Data absensi dipulihkan dari penyimpanan darurat', 'success');
                    }
                } catch (error) {
                    console.error('Emergency attendance storage failed:', error);
                }
            }
            
            // Initialize empty if all recovery methods failed
            if (!attendanceData) {
                attendanceData = [];
            }
        }

        // Save data to localStorage with user-specific keys
        function saveDataToStorage() {
            localStorage.setItem(`attendanceData_${currentUser}`, JSON.stringify(attendanceData));
            localStorage.setItem(`savedStudents_${currentUser}`, JSON.stringify(savedStudents));
            localStorage.setItem(`studentCounter_${currentUser}`, studentCounter.toString());
        }

        // Load students from localStorage for current user with backup recovery
        function loadStudentsFromStorage() {
            let savedStudentsData = localStorage.getItem(`savedStudents_${currentUser}`);
            let savedCounter = localStorage.getItem(`studentCounter_${currentUser}`);
            
            // Try primary storage first
            if (savedStudentsData) {
                try {
                    savedStudents = JSON.parse(savedStudentsData);
                    studentCounter = savedCounter ? parseInt(savedCounter) : savedStudents.length;
                } catch (error) {
                    console.error('Primary storage corrupted, trying backup:', error);
                    savedStudentsData = null;
                }
            }
            
            // Try backup storage if primary failed
            if (!savedStudentsData) {
                const backupStudents = localStorage.getItem(`backup_students_${currentUser}`);
                const backupCounter = localStorage.getItem(`backup_counter_${currentUser}`);
                
                if (backupStudents) {
                    try {
                        savedStudents = JSON.parse(backupStudents);
                        studentCounter = backupCounter ? parseInt(backupCounter) : savedStudents.length;
                        showSyncStatus('Data dipulihkan dari backup', 'success');
                    }
                    catch (error) {
                        console.error('Backup storage corrupted, trying global backup:', error);
                    }
                }
            }
            
            // Try global backup if both failed
            if (!savedStudents || savedStudents.length === 0) {
                try {
                    const globalBackup = JSON.parse(localStorage.getItem('globalBackup') || '{}');
                    if (globalBackup[currentUser] && globalBackup[currentUser].savedStudents) {
                        savedStudents = globalBackup[currentUser].savedStudents;
                        studentCounter = globalBackup[currentUser].studentCounter || savedStudents.length;
                        showSyncStatus('Data dipulihkan dari backup global', 'success');
                    }
                } catch (error) {
                    console.error('Global backup failed:', error);
                }
            }
            
            // Try emergency storage as last resort
            if (!savedStudents || savedStudents.length === 0) {
                try {
                    const emergency = JSON.parse(sessionStorage.getItem(`emergency_${currentUser}`) || '{}');
                    if (emergency.savedStudents) {
                        savedStudents = emergency.savedStudents;
                        studentCounter = emergency.studentCounter || savedStudents.length;
                        showSyncStatus('Data dipulihkan dari penyimpanan darurat', 'success');
                    }
                } catch (error) {
                    console.error('Emergency storage failed:', error);
                }
            }
            
            // Initialize empty if all recovery methods failed
            if (!savedStudents) {
                savedStudents = [];
                studentCounter = 0;
            }
            
            renderStudentTable();
        }

        // Render student table
        function renderStudentTable() {
            const tableBody = document.getElementById('studentTableBody');
            tableBody.innerHTML = '';
            
            savedStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-4 text-sm text-gray-900 font-medium">${index + 1}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900" contenteditable="true" onblur="updateStudentName(${student.id}, this.textContent)" style="background-color: #f9fafb; border-radius: 4px; margin: 2px;">${student.nama}</td>
                    <td class="px-4 py-4 text-sm text-gray-900 text-center" contenteditable="true" onblur="updateStudentClass(${student.id}, this.textContent)" style="background-color: #f9fafb; border-radius: 4px; margin: 2px;">${student.kelas}</td>
                    <td class="px-4 py-4 text-center">
                        <input type="radio" name="attendance_${student.id}" value="hadir" class="w-4 h-4 text-emerald-600 focus:ring-emerald-500 focus:ring-2" onchange="updateSummary()">
                    </td>
                    <td class="px-4 py-4 text-center">
                        <input type="radio" name="attendance_${student.id}" value="sakit" class="w-4 h-4 text-blue-600 focus:ring-blue-500 focus:ring-2" onchange="updateSummary()">
                    </td>
                    <td class="px-4 py-4 text-center">
                        <input type="radio" name="attendance_${student.id}" value="izin" class="w-4 h-4 text-yellow-600 focus:ring-yellow-500 focus:ring-2" onchange="updateSummary()">
                    </td>
                    <td class="px-4 py-4 text-center">
                        <input type="radio" name="attendance_${student.id}" value="alpha" class="w-4 h-4 text-red-600 focus:ring-red-500 focus:ring-2" onchange="updateSummary()">
                    </td>
                    <td class="px-6 py-4">
                        <input type="text" placeholder="Keterangan (opsional)..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
                    </td>
                    <td class="px-4 py-4 text-center">
                        <button onclick="editStudent(${student.id})" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium">
                            Edit
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Update student name
        function updateStudentName(id, newName) {
            const student = savedStudents.find(s => s.id === id);
            if (student) {
                student.nama = newName.trim();
                saveDataToStorage();
            }
        }

        // Update student class
        function updateStudentClass(id, newClass) {
            const student = savedStudents.find(s => s.id === id);
            if (student) {
                student.kelas = newClass.trim();
                saveDataToStorage();
            }
        }

        // Set today's date
        function setToday() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            
            document.getElementById('attendanceDate').value = `${year}-${month}-${day}`;
            updateDateDisplay();
        }

        // Update date display
        function updateDateDisplay() {
            const dateInput = document.getElementById('attendanceDate');
            if (!dateInput.value) return;
            
            const selectedDate = new Date(dateInput.value + 'T00:00:00');
            
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            
            const dayOptions = { 
                weekday: 'long'
            };
            
            document.getElementById('displayDate').textContent = 
                selectedDate.toLocaleDateString('id-ID', dateOptions);
            document.getElementById('dayName').textContent = 
                selectedDate.toLocaleDateString('id-ID', dayOptions);
            
            // Load saved summary for the selected date
            setTimeout(() => {
                loadSavedSummary();
            }, 50);
        }

        // Add new student
        function addStudent() {
            const nameInput = document.getElementById('studentName');
            const classInput = document.getElementById('studentClass');
            
            const nama = nameInput.value.trim();
            const kelas = classInput.value.trim();
            
            if (!nama || !kelas) {
                showErrorMessage('Mohon isi nama santri dan kelas dengan lengkap!');
                nameInput.focus();
                return;
            }
            
            // Check if student already exists
            const existingStudent = savedStudents.find(student => 
                student.nama.toLowerCase() === nama.toLowerCase()
            );
            
            if (existingStudent) {
                showErrorMessage(`Santri dengan nama "${nama}" sudah terdaftar!`);
                nameInput.focus();
                nameInput.select();
                return;
            }

            try {
                studentCounter++;
                const newStudent = {
                    id: studentCounter,
                    nama: nama,
                    kelas: kelas
                };
                
                savedStudents.push(newStudent);
                renderStudentTable();
                saveDataToStorage();
                
                nameInput.value = '';
                classInput.value = '';
                nameInput.focus();
                
                showSuccessMessage(`Santri "${nama}" dari kelas ${kelas} berhasil ditambahkan!`);
                
            } catch (error) {
                showErrorMessage('Gagal menambahkan santri. Silakan coba lagi!');
                console.error('Add student error:', error);
            }
        }

        // Edit student
        function editStudent(id) {
            const student = savedStudents.find(s => s.id === id);
            if (!student) return;
            
            // Create edit modal
            const editModal = document.createElement('div');
            editModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            editModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Edit Data Santri</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Santri</label>
                            <input type="text" id="editStudentName" value="${student.nama}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none" placeholder="Masukkan nama lengkap santri">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <input type="text" id="editStudentClass" value="${student.kelas}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none" placeholder="Contoh: 1A, 2B">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveEditedStudent(${student.id})" class="flex-1 bg-emerald-600 text-white py-2 px-4 rounded-lg hover:bg-emerald-700 transition-colors font-medium">
                            Simpan Perubahan
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors font-medium">
                            Batal
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
            
            // Focus on name input
            setTimeout(() => {
                document.getElementById('editStudentName').focus();
                document.getElementById('editStudentName').select();
            }, 100);
        }

        // Save edited student
        function saveEditedStudent(id) {
            const newName = document.getElementById('editStudentName').value.trim();
            const newClass = document.getElementById('editStudentClass').value.trim();
            
            if (!newName || !newClass) {
                showMessageModal('error', 'Gagal!', 'Mohon isi nama santri dan kelas dengan lengkap!', 'OK');
                return;
            }
            
            // Check if new name already exists (excluding current student)
            const existingStudent = savedStudents.find(student => 
                student.nama.toLowerCase() === newName.toLowerCase() && student.id !== id
            );
            
            if (existingStudent) {
                showMessageModal('error', 'Gagal!', `Santri dengan nama "${newName}" sudah terdaftar!`, 'OK');
                return;
            }
            
            // Find and update the student
            const studentIndex = savedStudents.findIndex(s => s.id === id);
            if (studentIndex !== -1) {
                const oldName = savedStudents[studentIndex].nama;
                
                // Update student data
                savedStudents[studentIndex].nama = newName;
                savedStudents[studentIndex].kelas = newClass;
                
                // Update all attendance records with the new name and class
                attendanceData.forEach(record => {
                    if (record.nama === oldName) {
                        record.nama = newName;
                        record.kelas = newClass;
                    }
                });
                
                // Save changes
                saveDataToStorage();
                renderStudentTable();
                updateSummary();
                
                // Close modal
                document.querySelector('.fixed.inset-0').remove();
                
                showSuccessMessage(`Data santri berhasil diperbarui dari "${oldName}" menjadi "${newName}" kelas ${newClass}!`);
            }
        }

        // Update attendance summary
        function updateSummary() {
            const hadirInputs = document.querySelectorAll('input[value="hadir"]:checked');
            const sakitInputs = document.querySelectorAll('input[value="sakit"]:checked');
            const izinInputs = document.querySelectorAll('input[value="izin"]:checked');
            const alphaInputs = document.querySelectorAll('input[value="alpha"]:checked');
            
            document.getElementById('hadirCount').textContent = hadirInputs.length;
            document.getElementById('sakitCount').textContent = sakitInputs.length;
            document.getElementById('izinCount').textContent = izinInputs.length;
            document.getElementById('alphaCount').textContent = alphaInputs.length;
        }

        // Load saved summary if within 12 hours
        function loadSavedSummary() {
            try {
                const savedSummary = localStorage.getItem(`dailySummary_${currentUser}`);
                if (savedSummary) {
                    const summaryData = JSON.parse(savedSummary);
                    const currentTime = Date.now();
                    const twelveHours = 12 * 60 * 60 * 1000; // 12 hours in milliseconds
                    
                    // Check if summary is within 12 hours and for current date
                    const currentDate = document.getElementById('attendanceDate').value;
                    if (summaryData.date === currentDate && (currentTime - summaryData.timestamp) < twelveHours) {
                        document.getElementById('hadirCount').textContent = summaryData.hadir;
                        document.getElementById('sakitCount').textContent = summaryData.sakit;
                        document.getElementById('izinCount').textContent = summaryData.izin;
                        document.getElementById('alphaCount').textContent = summaryData.alpha;
                        
                        // Also restore the radio button states for the current date
                        restoreAttendanceState(currentDate);
                    } else {
                        // Clear old summary data
                        localStorage.removeItem(`dailySummary_${currentUser}`);
                    }
                }
            } catch (error) {
                console.error('Error loading saved summary:', error);
            }
        }

        // Restore attendance state for current date
        function restoreAttendanceState(date) {
            const todayAttendance = attendanceData.filter(data => data.tanggal === date);
            
            savedStudents.forEach((student, index) => {
                const studentAttendance = todayAttendance.find(data => data.nama === student.nama);
                if (studentAttendance) {
                    const radioButton = document.querySelector(`input[name="attendance_${student.id}"][value="${studentAttendance.status}"]`);
                    if (radioButton) {
                        radioButton.checked = true;
                    }
                    
                    // Restore keterangan
                    const rows = document.querySelectorAll('#studentTableBody tr');
                    if (rows[index]) {
                        const keteranganInput = rows[index].querySelector('input[type="text"]');
                        if (keteranganInput && studentAttendance.keterangan) {
                            keteranganInput.value = studentAttendance.keterangan;
                        }
                    }
                }
            });
        }

        // Save attendance
        function saveAttendance() {
            const dateInput = document.getElementById('attendanceDate');
            if (!dateInput.value) {
                showErrorMessage('Mohon pilih tanggal absensi terlebih dahulu!');
                return;
            }
            
            const rows = document.querySelectorAll('#studentTableBody tr');
            let savedCount = 0;
            let totalStudents = savedStudents.length;
            
            if (totalStudents === 0) {
                showErrorMessage('Belum ada santri yang terdaftar. Silakan tambah santri terlebih dahulu!');
                return;
            }
            
            rows.forEach((row, index) => {
                const student = savedStudents[index];
                if (!student) return;
                
                const attendanceRadios = row.querySelectorAll('input[type="radio"]');
                const keterangan = row.querySelector('input[type="text"]').value.trim();
                
                let status = null;
                attendanceRadios.forEach(radio => {
                    if (radio.checked) {
                        status = radio.value;
                    }
                });
                
                if (status) {
                    // Remove existing data for same date and student
                    attendanceData = attendanceData.filter(data => 
                        !(data.tanggal === dateInput.value && data.nama === student.nama)
                    );
                    
                    // Add new data
                    attendanceData.push({
                        tanggal: dateInput.value,
                        nama: student.nama,
                        kelas: student.kelas,
                        status: status,
                        keterangan: keterangan
                    });
                    
                    savedCount++;
                }
            });
            
            if (savedCount === 0) {
                showErrorMessage('Tidak ada data absensi yang dipilih. Mohon pilih status kehadiran untuk setiap santri!');
                return;
            }
            
            try {
                saveDataToStorage();
                
                // Save summary data with timestamp for 12-hour persistence
                const summaryData = {
                    hadir: document.getElementById('hadirCount').textContent,
                    sakit: document.getElementById('sakitCount').textContent,
                    izin: document.getElementById('izinCount').textContent,
                    alpha: document.getElementById('alphaCount').textContent,
                    date: dateInput.value,
                    timestamp: Date.now()
                };
                localStorage.setItem(`dailySummary_${currentUser}`, JSON.stringify(summaryData));
                
                const displayDate = document.getElementById('displayDate').textContent;
                showSuccessMessage(`Absensi untuk ${savedCount} santri pada tanggal ${displayDate} berhasil disimpan!`);
                
                // Don't clear radio buttons and text inputs - keep them for 12 hours
                
            } catch (error) {
                showErrorMessage('Gagal menyimpan data absensi. Silakan coba lagi!');
                console.error('Save error:', error);
            }
        }

        // Update dashboard
        function updateDashboard() {
            updateDashboardStats();
            updateSummaryTable();
            updateDashboardTable();
            updateRecentActivity();
        }

        // Update summary table
        function updateSummaryTable() {
            const tableBody = document.getElementById('summaryTableBody');
            tableBody.innerHTML = '';
            
            savedStudents.forEach((student, index) => {
                const studentAttendance = attendanceData.filter(data => data.nama === student.nama);
                
                const hadirCount = studentAttendance.filter(data => data.status === 'hadir').length;
                const sakitCount = studentAttendance.filter(data => data.status === 'sakit').length;
                const izinCount = studentAttendance.filter(data => data.status === 'izin').length;
                const alphaCount = studentAttendance.filter(data => data.status === 'alpha').length;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">${hadirCount}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${sakitCount}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">${izinCount}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">${alphaCount}</span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add message if no students
            if (savedStudents.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        Belum ada data santri. Silakan tambah santri terlebih dahulu.
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            const uniqueStudents = [...new Set(attendanceData.map(data => data.nama))];
            const totalHadir = attendanceData.filter(data => data.status === 'hadir').length;
            const totalSakit = attendanceData.filter(data => data.status === 'sakit').length;
            const totalIzin = attendanceData.filter(data => data.status === 'izin').length;
            const totalAlpha = attendanceData.filter(data => data.status === 'alpha').length;
            
            document.getElementById('totalStudents').textContent = savedStudents.length;
            document.getElementById('totalHadir').textContent = totalHadir;
            document.getElementById('totalSakit').textContent = totalSakit;
            document.getElementById('totalIzin').textContent = totalIzin;
            document.getElementById('totalAlpha').textContent = totalAlpha;
        }

        // Update recent activity
        function updateRecentActivity() {
            const recentContainer = document.getElementById('recentActivity');
            const recentData = attendanceData.slice(-5).reverse();
            
            recentContainer.innerHTML = '';
            
            if (recentData.length === 0) {
                recentContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada aktivitas</p>';
                return;
            }
            
            recentData.forEach(data => {
                const color = data.status === 'hadir' ? 'emerald' : 
                             data.status === 'izin' ? 'yellow' : 'red';
                
                const activityDiv = document.createElement('div');
                activityDiv.className = 'flex items-center p-3 bg-gray-50 rounded-lg';
                activityDiv.innerHTML = `
                    <div class="w-2 h-2 bg-${color}-500 rounded-full mr-3"></div>
                    <div>
                        <p class="text-sm font-medium text-gray-900">${data.nama} - ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}</p>
                        <p class="text-xs text-gray-500">${data.tanggal}</p>
                    </div>
                `;
                recentContainer.appendChild(activityDiv);
            });
        }

        // Update dashboard table with attendance records
        function updateDashboardTable(filteredData = null) {
            const tableBody = document.getElementById('dashboardTableBody');
            tableBody.innerHTML = '';
            
            // Use filtered data if provided, otherwise use all data
            const dataToShow = filteredData || attendanceData;
            
            // Sort attendance data by date (newest first)
            const sortedData = [...dataToShow].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            // Display attendance records
            sortedData.forEach((record, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Format date to Indonesian format
                const date = new Date(record.tanggal + 'T00:00:00');
                const formattedDate = date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
                
                // Status badge styling
                let statusBadge = '';
                if (record.status === 'hadir') {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">Hadir</span>';
                } else if (record.status === 'sakit') {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Sakit</span>';
                } else if (record.status === 'izin') {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Izin</span>';
                } else if (record.status === 'alpha') {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Alpha</span>';
                }
                
                row.innerHTML = `
                    <td class="px-4 py-4 text-sm text-gray-900 font-medium">${index + 1}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 font-medium">${formattedDate}</td>
                    <td class="px-6 py-4 text-sm font-semibold text-gray-900">${record.nama}</td>
                    <td class="px-4 py-4 text-sm text-gray-900 text-center font-medium">${record.kelas}</td>
                    <td class="px-6 py-4 text-center">${statusBadge}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${record.keterangan || '-'}</td>
                    <td class="px-4 py-4 text-center">
                        <button onclick="editAttendanceRecord('${record.tanggal}', '${record.nama}')" class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium">
                            Edit
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add message if no data
            if (sortedData.length === 0) {
                const message = filteredData !== null ? 'Tidak ada data yang sesuai dengan pencarian.' : 'Belum ada data absensi. Silakan lakukan absensi terlebih dahulu.';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                        ${message}
                    </td>
                `;
                tableBody.appendChild(row);
            }
        }

        // Search attendance function
        function searchAttendance() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                updateDashboardTable(); // Show all data
                return;
            }
            
            const filteredData = attendanceData.filter(record => {
                const nama = record.nama.toLowerCase();
                const tanggal = record.tanggal;
                const kelas = record.kelas.toLowerCase();
                const status = record.status.toLowerCase();
                const keterangan = (record.keterangan || '').toLowerCase();
                
                // Format date for search
                const date = new Date(tanggal + 'T00:00:00');
                const formattedDate = date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
                
                return nama.includes(searchTerm) || 
                       tanggal.includes(searchTerm) || 
                       formattedDate.includes(searchTerm) ||
                       kelas.includes(searchTerm) ||
                       status.includes(searchTerm) ||
                       keterangan.includes(searchTerm);
            });
            
            updateDashboardTable(filteredData);
        }

        // Clear search function
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            updateDashboardTable(); // Show all data
        }

        // Show success message
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 transform transition-all duration-300 ease-in-out';
            messageDiv.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                ${message}
            `;
            
            document.body.appendChild(messageDiv);
            
            // Animate in
            setTimeout(() => {
                messageDiv.style.transform = 'translateX(0)';
            }, 10);
            
            // Animate out and remove
            setTimeout(() => {
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3500);
        }

        // Add visibility change detection for better app detection
        let visibilityChangeDetected = false;
        
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                visibilityChangeDetected = true;
            }
        });
        
        // Add page focus/blur detection
        let pageFocused = true;
        
        window.addEventListener('blur', function() {
            pageFocused = false;
        });
        
        window.addEventListener('focus', function() {
            pageFocused = true;
        });

        // PWA and Offline functionality
        let deferredPrompt;
        let isOnline = navigator.onLine;
        
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Register service worker with inline code
                const swCode = `
                    const CACHE_NAME = 'absensi-madrasah-v1';
                    const urlsToCache = [
                        './',
                        'https://cdn.tailwindcss.com',
                        'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            const installButton = document.getElementById('installButton');
            installButton.classList.add('show');
            
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        hideInstallButton();
                    }
                    deferredPrompt = null;
                }
            });
        }

        function hideInstallButton() {
            const installButton = document.getElementById('installButton');
            installButton.classList.remove('show');
        }

        // Online/Offline Detection
        function updateConnectionStatus() {
            const indicator = document.getElementById('offlineIndicator');
            const statusText = document.getElementById('connectionStatus');
            
            if (navigator.onLine) {
                statusText.textContent = 'Koneksi internet tersambung - Mode online';
                indicator.classList.add('online');
                indicator.classList.add('show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            } else {
                statusText.textContent = 'Tidak ada koneksi internet - Mode offline aktif';
                indicator.classList.remove('online');
                indicator.classList.add('show');
            }
            
            isOnline = navigator.onLine;
        }

        // Connection event listeners
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Initialize on page load
        window.addEventListener('load', function() {
            updateConnectionStatus();
            
            // Show install button after 5 seconds if not installed
            setTimeout(() => {
                if (!window.matchMedia('(display-mode: standalone)').matches && !deferredPrompt) {
                    // Check if it's a mobile device
                    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                        showInstallPrompt();
                    }
                }
            }, 5000);
        });

        function showInstallPrompt() {
            const installButton = document.getElementById('installButton');
            installButton.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Tambah ke Home Screen
            `;
            installButton.classList.add('show');
            
            installButton.onclick = function() {
                showManualInstallInstructions();
            };
        }

        function showManualInstallInstructions() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let instructions = '';
            
            if (isIOS) {
                instructions = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                            <h3 class="text-lg font-semibold mb-4">Install Aplikasi</h3>
                            <div class="space-y-3 text-sm">
                                <p>1. Tap tombol Share di Safari</p>
                                <p>2. Pilih "Add to Home Screen"</p>
                                <p>3. Tap "Add" untuk install</p>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="mt-4 w-full bg-emerald-600 text-white py-2 rounded-lg">
                                Mengerti
                            </button>
                        </div>
                    </div>
                `;
            } else if (isAndroid) {
                instructions = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                            <h3 class="text-lg font-semibold mb-4">Install Aplikasi</h3>
                            <div class="space-y-3 text-sm">
                                <p>1. Tap menu (‚ãÆ) di Chrome</p>
                                <p>2. Pilih "Add to Home screen"</p>
                                <p>3. Tap "Add" untuk install</p>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="mt-4 w-full bg-emerald-600 text-white py-2 rounded-lg">
                                Mengerti
                            </button>
                        </div>
                    </div>
                `;
            } else {
                instructions = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                            <h3 class="text-lg font-semibold mb-4">Bookmark Halaman</h3>
                            <div class="space-y-3 text-sm">
                                <p>Tekan Ctrl+D (Windows) atau Cmd+D (Mac) untuk bookmark halaman ini agar mudah diakses.</p>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="mt-4 w-full bg-emerald-600 text-white py-2 rounded-lg">
                                Mengerti
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.body.insertAdjacentHTML('beforeend', instructions);
            hideInstallButton();
        }

        // Enhanced localStorage with offline sync and backup
        function saveDataToStorageEnhanced() {
            try {
                const timestamp = new Date().toISOString();
                const data = {
                    attendanceData: attendanceData,
                    savedStudents: savedStudents,
                    studentCounter: studentCounter,
                    lastSync: timestamp,
                    version: '2.0',
                    user: currentUser
                };
                
                // Primary storage
                localStorage.setItem(`attendanceData_${currentUser}`, JSON.stringify(data.attendanceData));
                localStorage.setItem(`savedStudents_${currentUser}`, JSON.stringify(data.savedStudents));
                localStorage.setItem(`studentCounter_${currentUser}`, data.studentCounter.toString());
                localStorage.setItem(`lastSync_${currentUser}`, data.lastSync);
                localStorage.setItem(`version_${currentUser}`, data.version);
                
                // Backup storage with different keys
                localStorage.setItem(`backup_attendance_${currentUser}`, JSON.stringify(data.attendanceData));
                localStorage.setItem(`backup_students_${currentUser}`, JSON.stringify(data.savedStudents));
                localStorage.setItem(`backup_counter_${currentUser}`, data.studentCounter.toString());
                
                // Global backup (in case user-specific fails)
                const globalBackup = JSON.parse(localStorage.getItem('globalBackup') || '{}');
                globalBackup[currentUser] = data;
                localStorage.setItem('globalBackup', JSON.stringify(globalBackup));
                
                // Show sync status
                showSyncStatus('Data tersimpan dengan aman', 'success');
                
            } catch (error) {
                showSyncStatus('Gagal menyimpan data', 'error');
                console.error('Storage error:', error);
                
                // Try alternative storage method
                try {
                    sessionStorage.setItem(`emergency_${currentUser}`, JSON.stringify({
                        attendanceData, savedStudents, studentCounter
                    }));
                } catch (e) {
                    console.error('Emergency storage failed:', e);
                }
            }
        }

        function showSyncStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed bottom-4 left-4 px-4 py-2 rounded-lg text-white text-sm z-50 ${
                type === 'success' ? 'bg-green-600' : 'bg-red-600'
            }`;
            statusDiv.textContent = message;
            
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 3000);
        }

        // Override the original saveDataToStorage function
        function saveDataToStorage() {
            saveDataToStorageEnhanced();
        }

        // Edit attendance record
        function editAttendanceRecord(tanggal, nama) {
            const record = attendanceData.find(data => data.tanggal === tanggal && data.nama === nama);
            if (!record) return;
            
            // Create edit modal
            const editModal = document.createElement('div');
            editModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            editModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Edit Absensi</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Santri</label>
                            <input type="text" id="editNama" value="${record.nama}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                            <input type="date" id="editTanggal" value="${record.tanggal}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="editStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
                                <option value="hadir" ${record.status === 'hadir' ? 'selected' : ''}>Hadir</option>
                                <option value="sakit" ${record.status === 'sakit' ? 'selected' : ''}>Sakit</option>
                                <option value="izin" ${record.status === 'izin' ? 'selected' : ''}>Izin</option>
                                <option value="alpha" ${record.status === 'alpha' ? 'selected' : ''}>Alpha</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                            <input type="text" id="editKeterangan" value="${record.keterangan || ''}" placeholder="Keterangan..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveEditedRecord('${tanggal}', '${nama}')" class="flex-1 bg-emerald-600 text-white py-2 px-4 rounded-lg hover:bg-emerald-700 transition-colors">
                            Simpan
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                            Batal
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
        }

        // Save edited record
        function saveEditedRecord(originalTanggal, originalNama) {
            const newNama = document.getElementById('editNama').value.trim();
            const newTanggal = document.getElementById('editTanggal').value;
            const newStatus = document.getElementById('editStatus').value;
            const newKeterangan = document.getElementById('editKeterangan').value.trim();
            
            if (!newNama || !newTanggal || !newStatus) {
                showMessageModal('error', 'Gagal!', 'Mohon lengkapi semua field yang wajib diisi!', 'OK');
                return;
            }
            
            // Find and update the record
            const recordIndex = attendanceData.findIndex(data => 
                data.tanggal === originalTanggal && data.nama === originalNama
            );
            
            if (recordIndex !== -1) {
                attendanceData[recordIndex] = {
                    tanggal: newTanggal,
                    nama: newNama,
                    kelas: attendanceData[recordIndex].kelas,
                    status: newStatus,
                    keterangan: newKeterangan
                };
                
                saveDataToStorage();
                updateDashboard();
                
                // Close modal
                document.querySelector('.fixed.inset-0').remove();
                showSuccessMessage('Data berhasil diupdate!');
            }
        }
        
        // Delete attendance record
        function deleteAttendanceRecord(tanggal, nama) {
            // Format date for better display
            const date = new Date(tanggal + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'long', 
                year: 'numeric'
            });
            
            // Use custom modal for confirmation
            showMessageModal('confirm', 'Konfirmasi Hapus', `Apakah Anda yakin ingin menghapus data absensi:\n\nNama: ${nama}\nTanggal: ${formattedDate}\n\nData yang dihapus tidak dapat dikembalikan!`, 'Ya, Hapus', 'Batal', () => {
                const initialLength = attendanceData.length;
                attendanceData = attendanceData.filter(data => 
                    !(data.tanggal === tanggal && data.nama === nama)
                );
                
                if (attendanceData.length < initialLength) {
                    saveDataToStorage();
                    updateDashboard();
                    showSuccessMessage(`Data absensi ${nama} pada ${formattedDate} berhasil dihapus!`);
                } else {
                    showErrorMessage('Gagal menghapus data. Data tidak ditemukan.');
                }
                hideMessageModal(); // Hide modal after action
            }, () => {
                hideMessageModal(); // Hide modal if cancelled
            });
        }

        // Show success message
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 transform transition-all duration-300 ease-in-out';
            messageDiv.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                ${message}
            `;
            
            document.body.appendChild(messageDiv);
            
            // Animate in
            setTimeout(() => {
                messageDiv.style.transform = 'translateX(0)';
            }, 10);
            
            // Animate out and remove
            setTimeout(() => {
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3500);
        }

        // Show error message (updated to use custom modal)
        function showErrorMessage(message) {
            showMessageModal('error', 'Terjadi Kesalahan!', message, 'OK');
        }

        // Custom Message Box Functions
        const messageModal = document.getElementById('messageModal');
        const messageModalIcon = document.getElementById('messageModalIcon');
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalBody = document.getElementById('messageModalBody');
        const messageModalButton = document.getElementById('messageModalButton');
        const messageModalCancelButton = document.getElementById('messageModalCancelButton'); // New cancel button

        function showMessageModal(type, title, message, buttonText = 'OK', cancelButtonText = '', onConfirm = null, onCancel = null) {
            messageModalTitle.textContent = title;
            messageModalBody.textContent = message;
            messageModalButton.textContent = buttonText;
            messageModalButton.className = `message-modal-button ${type === 'success' ? 'success' : 'error'}`;
            
            messageModalIcon.innerHTML = ''; // Clear previous icon
            if (type === 'success') {
                messageModalIcon.innerHTML = `<svg class="w-12 h-12 text-emerald-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else if (type === 'error') {
                messageModalIcon.innerHTML = `<svg class="w-12 h-12 text-red-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else if (type === 'confirm') {
                messageModalIcon.innerHTML = `<svg class="w-12 h-12 text-yellow-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9.247a4.5 4.5 0 000 5.506m0 0l-1.5 1.5m1.5-1.5l1.5 1.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            }

            messageModalButton.onclick = onConfirm || hideMessageModal;

            if (type === 'confirm' && cancelButtonText && onCancel) {
                messageModalCancelButton.textContent = cancelButtonText;
                messageModalCancelButton.classList.remove('hidden');
                messageModalCancelButton.onclick = onCancel;
                messageModalButton.className = `message-modal-button success`; // Make confirm button green
                messageModalCancelButton.className = `message-modal-button error ml-2`; // Make cancel button red
            } else {
                messageModalCancelButton.classList.add('hidden');
            }

            messageModal.classList.add('show');
        }

        function hideMessageModal() {
            messageModal.classList.remove('show');
        }

        // Add event listeners for attendance radio buttons
        document.addEventListener('change', function(e) {
            if (e.target.type === 'radio' && e.target.name.startsWith('attendance_')) {
                updateSummary();
            }
        });

        // --- New Export/Import Functions ---

        /**
         * Exports all attendance and student data to a JSON file.
         */
        function exportData() {
            try {
                const dataToExport = {
                    attendanceData: attendanceData,
                    savedStudents: savedStudents,
                    studentCounter: studentCounter,
                    exportedAt: new Date().toISOString(),
                    exportedBy: currentUser
                };

                const filename = `absensi_madrasah_data_${currentUser}_${new Date().toISOString().slice(0,10)}.json`;
                const jsonString = JSON.stringify(dataToExport, null, 2); // Pretty print JSON

                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url); // Clean up

                showSuccessMessage('Data absensi berhasil diekspor!');
            } catch (error) {
                showErrorMessage('Gagal mengekspor data. Silakan coba lagi.');
                console.error('Export data error:', error);
            }
        }

        /**
         * Handles the file input change for importing data.
         * @param {Event} event - The change event from the file input.
         */
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            if (file.type !== 'application/json') {
                showErrorMessage('Format file tidak didukung. Mohon unggah file JSON.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Validate imported data structure
                    if (importedData && 
                        Array.isArray(importedData.attendanceData) &&
                        Array.isArray(importedData.savedStudents) &&
                        typeof importedData.studentCounter === 'number') {
                        
                        showMessageModal('confirm', 'Konfirmasi Impor Data', 
                            'Apakah Anda yakin ingin mengimpor data ini? Data yang ada saat ini akan diganti.', 
                            'Ya, Impor', 'Batal', 
                            () => {
                                // Perform import
                                attendanceData = importedData.attendanceData;
                                savedStudents = importedData.savedStudents;
                                studentCounter = importedData.studentCounter;
                                
                                saveDataToStorage(); // Save imported data to localStorage
                                initializeApp(); // Re-initialize app to refresh UI
                                showSuccessMessage('Data absensi berhasil diimpor!');
                                hideMessageModal();
                            },
                            () => {
                                hideMessageModal(); // Cancel import
                            }
                        );
                    } else {
                        showErrorMessage('Struktur file JSON tidak valid. Mohon unggah file ekspor yang benar.');
                    }
                } catch (error) {
                    showErrorMessage('Gagal memproses file. Pastikan itu adalah file JSON yang valid.');
                    console.error('Import file processing error:', error);
                }
            };
            reader.readAsText(file);

            // Clear the file input value to allow re-importing the same file
            event.target.value = '';
        }

        // Initial app load
        window.addEventListener('DOMContentLoaded', () => {
            // Check for existing login
            if (localStorage.getItem(`currentUser`)) { // Assuming currentUser is saved
                currentUser = localStorage.getItem(`currentUser`);
                // Re-set display name based on current user (logic from handleLogin)
                let displayName = currentUser;
                if (currentUser === 'adit') {
                    displayName = 'Ustad Adit';
                } else if (currentUser === 'lilis') {
                    displayName = 'Ustadzah Lilis';
                } else if (currentUser === 'rizqi') {
                    displayName = 'Ustad Rizqi';
                } else if (currentUser === 'dudu') {
                    displayName = 'Ustad Dudu';
                }
                document.getElementById('currentUser').textContent = displayName;
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                showPage('attendance'); // Default to attendance page
                initializeApp();
            } else {
                // If no current user, show login page
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('username').focus();
            }
        });

        // Event listener for attendance radio buttons (already present, keep as is)
        document.addEventListener('change', function(e) {
            if (e.target.type === 'radio' && e.target.name.startsWith('attendance_')) {
                updateSummary();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'969152ce817f37b5',t:'MTc1NDE3NzAxMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
